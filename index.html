<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Wishlist</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&family=Playwrite+CO+Guides&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="styles.css">
    </head>

    <body>
        <h1>Sasha's Wishlist</h1>
        <table id="gifts-table">
            <thead>
                <tr>
                    <th>Подарок</th>
                    <th>Комментарий</th>
                    <th>Подарок выбран</th>
                </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
        <div class='loader-container'>
            <span id="loader" class="loader" style="display: block;"></span>
        </div>

        <script>
            const scriptUrl = 'https://script.google.com/macros/s/AKfycbwSLaShL-N5m5XLscc8Yh6StmqVoWm2935RFpMtJV-3s5HBnyYH5RoImEi6OZ_cqtd6gg/exec';

            async function fetchData() {
                const loader = document.getElementById('loader');

                let response;

                try {
                    response = await fetch(scriptUrl,
                    {
                        method: 'GET',
                    });

                } catch (error) {
                    console.error('Error:', error);
                    const p = document.createElement('p');
                    p.textContent = 'Failed to load data. Please try again later.';
                    document.body.appendChild(p);
                    return;
                } finally {
                    loader.style.display = 'none';
                }

                const data = await response.json();
                const tbody = document.querySelector('#gifts-table tbody');
                tbody.innerHTML = '';

                data.slice(1).forEach(row => {
                    appendRow(row, tbody);
                });

                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', async (e) => {
                        const description = e.target.getAttribute('data-description');
                        const selected = e.target.checked;

                        await fetch(scriptUrl, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ description, selected }),
                        });
                    });
                });
            }

            function appendRow(row, tbody) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row[0]}</td>
                    <td>${replaceUrlsWithLinks(row[1])}</td>
                    <td>
                        <label>
                        <input type="checkbox" ${row[2] ? 'checked disabled' : ''}
                            data-description="${row[0]}">
                            <span class="custom-checkbox ${row[2] ? ' checkbox-fetched-checked' : 'checkbox-fetched-unchecked'}"></span>
                        </label>

                    </td>
                `;
                tbody.appendChild(tr);
            }

            function replaceUrlsWithLinks (text) {
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                return text.replace(urlRegex, (url) => {
                    const urlObj = new URL(url);
                    const domain = urlObj.hostname;
                    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${domain}</a>`;
                });
            };

            fetchData();
        </script>
    </body>
</html>
